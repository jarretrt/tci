---
title: "Simulation from a user-specified, ODE-based PK model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation from a user-specified, ODE-based PK model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibfile.bib  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### User-defined PK functions using the tci package

The `tci` package provides closed-form solutions for 1-, 2-, 3-, and 3-compartment with effect-site PK models based on solutions described and code provided in @Abuhelwa2015. It does not, however, include an ordinary differential equation (ODE) solver as many other R packages do, including [mrgsolve](https://mrgsolve.github.io/), [PKPDsim](http://pkpdsim.ronkeizer.com/), and [RxODE](https://github.com/nlmixrdevelopment/RxODE). `tci` package functions can nonetheless be applied to models from these packages through the creation of user-defined PK functions.
 
User-defined PK functions should be created to return concentrations at a vector of time points under a continuous infusion and should be assigned S3 class "pkmod." 

To illustrate, we create an example two-compartment model based on ODEs is illustrated using the `PKPDsim` R package[@PKPDsim] which can be installed from GitHub.

```{r, install-PKPDsim, eval = FALSE}
devtools::install_github("ronkeizer/PKPDsim") # install PKPDsim
```

Using `PKPDsim` syntax, a model can be specified. 

```{r, mrgsolve-example, warning=FALSE}
library(tci)
library(PKPDsim)

# define custom two-compartment model from PKPDsim
pk2 <- new_ode_model(code = "
  dAdt[1] = -(CL/V)*A[1] - (Q/V)*A[1] + (Q/V2)*A[2]
  dAdt[2] = -(Q/V2)*A[2] + (Q/V)*A[1]
  
", parameters = c("CL","V","Q","V2")
)
```

A wrapper function is then created to take as arguments a time at which to evaluate the PK model (`tm`), an infusion rate (`kR`), PK model parameters (`pars`), initial concentrations (`init`), and an infusion starting time (`inittm`). The starting time is used by functions in `tci` that iteratively calculate concentrations from a series of infusions. Within this function, the `PKPDsim` functions "new_regimen" and "sim" are used to specify and predict from an infusion schedule. 

```{r}
# wrapper function to evaluate pk2 in format used by tci
pkmod2cpt_ode <- function(tm, kR, pars, 
                          pkm = pk2, 
                          init = c(0,0), 
                          inittm = 0){
  
  # start times at 0 and use uppercase names for PKPDsim functions
  tm <- tm - inittm
  names(pars) <- toupper(names(pars))
  # pass parameters as list
  pars <- sapply(pars, as.list)
  
  # dosing regimen - PKPDsim function
  reg <- new_regimen(
    amt = kR,
    times = 0,
    type = "infusion",
    t_inf = max(tm)
  )
  
  vols <- unlist(pars[c("V","V2")])
  
  # predict amounts
  dat <- sim(
    ode = pk2,              
    parameters = pars,
    regimen = reg,
    A_init = init*vols, # init specifies concentrations
    t_obs = tm
  )
  
  # return concentrations with compartments in rows and times in columns
  datw <-reshape(dat[dat$comp %in% c(1,2),], idvar = "t", 
                 v.names = "y", 
                 timevar = "comp",
          direction = "wide")
  
  cons <- t(datw[,c("y.1","y.2")]) / vols
  
  rownames(cons) <- colnames(cons) <- NULL
  return(cons)
}
class(pkmod2cpt_ode) <- "pkmod"
```

For use with the `tci` package, the user-defined PK function should have class "pkmod". We can now assign parameter values and predict from this model as we would any other. 

```{r, fig.height= 6, fig.width = 6}
# create dose
dose <- create_intvl(
  as.matrix(cbind(time = c(0.5,4,4.5,10), 
                  infrt = c(100,0,100,0)))
)

# model parameters
pars_2cpt <- c(CL = 15, V = 10, Q = 10, V2 = 20)

# predict concentrations
predict(pkmod2cpt_ode, 
        pars = pars_2cpt, 
        inf = dose, 
        tms = c(1,2,3))

# plot concentrations
plot(pkmod2cpt_ode, 
     pars = pars_2cpt, 
     inf = dose, 
     title = "Concentrations for a user-defined 2-compartment model")
```


We can also apply TCI algorithms to calculate infusion schedules required to reach designated targets with the user-defined model. 

```{r, user-defined-tci, fig.height= 6, fig.width = 6}
# target concentration = 1 for times 0 - 5
# target concentration = 2 for times 5 - 10
tci_times <- c(0,5,10)
tci_targets <- c(1,2,2)

# plasma-targeting
inf_3cpt_plasma <- tci(Ct = tci_targets, 
                       tms = tci_times, 
                       pkmod = pkmod2cpt_ode, 
                       pars = pars_2cpt, 
                       tci_alg = "plasma")
# print infusion schedule
head(inf_3cpt_plasma)

# plot infusion schedule
plot(inf_3cpt_plasma)
```


### References




